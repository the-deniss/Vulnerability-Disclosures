# CVE-2023-ASWSBX

## Description

Avast Antivirus' Sandbox component (`AswEngSrv.exe`) doesn't prevent sandboxed malicious code from scheduling 
task and become back token without restricted SID, job and with powerfull privileges. I have already found a 
similar bug CVE-2021-45336 and it is obvious that the current vulnerability is a badly fixed previous one.

## Impact

An attacker who finds a vulnerability in a scanner and has the ability to execution in a sandbox can elevate their 
privileges and execute arbitrary code as "NT Authority\System".

## Steps to reproduce

For this demo I did not build a chain of exploitation as in 
[this PoC](https://github.com/the-deniss/Vulnerability-Disclosures/blob/main/CVE-2021-45335%20&%20CVE-2021-45336%20&%20CVE-2021-45337/README.md), 
so you need to inject the code into the low-privileged `aswEngSrv.exe` yourself. And this code will escape the sandbox 
and acquire "NT Authority\System" privileges.

1. Copy `AswSandboxTsRpcEscape.dll` and (`powercat.ps1`)[https://github.com/the-deniss/Vulnerability-Disclosures/blob/main/Common/powercat/powercat.ps1] 
to the host;
2. Grant `Authenticated Users` permissions to read and execute the file `AswSandboxTsRpcEscape.dll`;
3. Disable Avast Self-Defense;
4. Run (`ProcessHacker`)[https://processhacker.sourceforge.io/] as Administrator and inject `AswSandboxTsRpcEscape.dll` into a process `aswEngSrv.exe`;
5. Wait a moment and run just created from sandbox task `schtasks /Run /TN "\AvastSandboxEscape"`;
6. Run PowerShell.exe as user and connect to spawned shell: `. .\powercat.ps1;powercat -c 127.0.0.1 -p 12345`;
7. Enjoy SYSTEM privileges!

## Resolution


## Disclosure Timeline


## References

[CVE-2021-45336](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-45336)

[Avast Hall of Fame](https://www.avast.com/hacker-hall-of-fame/en/researcher-david-eade-reports-antitrack-bug-to-avast-0)
